---
title: "10b_hubs_and_keystones_part_2"
output: html_document
date: "2023-05-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Goal: For the hub and keystone candidate taxa identified in the previous script, see what the habitat, host, and EMPO3 affiliations are (plus taxonomy).

```{r}
library(dplyr)
library(brainGraph)
library(igraph)
```


```{r}

# import data
fung_abun <- readRDS("../intermediates/global/fully_filtered_p20_fungal_otu_table_matched_up.rds")
bact_abun <- readRDS("../intermediates/global/fully_filtered_p20_bact_otu_table_matched_up.rds")

fung_meta <- readRDS("../intermediates/global/fully_filtered_p20_fungal_otu_metadata_matched_up.rds")
bact_meta <- readRDS("../intermediates/global/fully_filtered_p20_bact_otu_metadata_matched_up.rds")

# some data formatting
fung_meta$trophic[!(fung_meta$trophic %in% c("PrimaryProducer", "Environmental"))] <- "Consumer"
bact_meta$trophic[!(bact_meta$trophic %in% c("PrimaryProducer", "Environmental"))] <- "Consumer"

fung_abun <- fung_abun[row.names(fung_abun)!="dummy",]
bact_abun <- bact_abun[row.names(bact_abun)!="dummy",]


## hubs
fung_hub_data <- readRDS("../intermediates/full_fung_hub_data.rds")
bact_hub_data <- readRDS("../intermediates/full_bact_hub_data.rds")
cross_hub_data <- readRDS("../intermediates/full_cross_hub_data.rds")

# read in data = 20% prevalence global networks
fung_net <- readRDS("../intermediates/global/fung20_igraph.rds")
bact_net <- readRDS("../intermediates/global/bact20_igraph.rds")
cross_net <- readRDS("../intermediates/global/cross20_igraph.rds")


```

## Pie chart stuff

```{r}
hsize = 4

make_pie <- function(hub_name, abun, meta, color_palette, var_to_filt_by) {

  filt_abun <- abun[rownames(abun) == hub_name,]
  filt_abun <- filt_abun[,colSums(filt_abun)>0]
  
  filt_sd <- meta[meta$x_seq_id %in% names(filt_abun),]
  
  df <- filt_sd %>% group_by_at(var_to_filt_by) %>% summarise(count=length(sequencing_id))
  df$pct <- df$count/sum(df$count)

  df <- df %>% mutate(x = hsize)
  
  
  my_plot <- ggplot(df, aes(x = hsize, y = count, fill = factor(!!sym(var_to_filt_by), levels = names(color_palette)))) +
                geom_col() +
                coord_polar(theta = "y") +
                xlim(c(0.2, hsize + 0.5)) +
                theme_blank() +
                labs(title=paste(hub_name), fill=var_to_filt_by) +
                scale_fill_manual(values=color_palette, drop=FALSE)
  
  return(my_plot)
}


library(paletteer)

empo_pal <- paletteer_d("miscpalettes::pastel", 14)
names(empo_pal) <- unique(fung_meta$empo_3)

troph_pal <- paletteer_d("IslamicArt::samarqand2", 3)
names(troph_pal) <- unique(fung_meta$trophic)

hab_pal <- paletteer_d("nbapalettes::pacers_foundation", 3)
names(hab_pal) <- unique(fung_meta$habitat)

```


## Hubs

### Fungi 
```{r}

fung_hub_names <- fung_hub_data$OTU[1:5]

# how many samples
fung_how_many_samps <- list()
for (a_hub in fung_hub_names) {
  filt_f_abun <- fung_abun[rownames(fung_abun)==a_hub,]
  filt_f_abun <- filt_f_abun[,colSums(filt_f_abun)>0]
  
  fung_how_many_samps[[a_hub]] <- ncol(filt_f_abun)
}

fs_df <- as.data.frame(unlist(fung_how_many_samps))
names(fs_df) <- "how_many_samps"

f_hub_tax <- fung_seed_tax[fung_seed_tax$denovo_OTU %in% fung_hub_names,]
f_hub_tax <- f_hub_tax[,3:9]

fs_df <- cbind(fs_df, f_hub_tax)

saveRDS(fs_df, "../intermediates/global/fung_hubs_how_many_samps.rds")

fung_hubs_empo <- lapply(fung_hub_names,
                         make_pie,
                         abun = fung_abun,
                         meta = fung_meta,
                         color_palette = empo_pal,
                         var_to_filt_by = "empo_3")

fung_hubs_hab <- lapply(fung_hub_names,
                         make_pie,
                         abun = fung_abun,
                         meta = fung_meta,
                         color_palette = hab_pal,
                         var_to_filt_by = "habitat")

fung_hubs_troph <- lapply(fung_hub_names,
                         make_pie,
                         abun = fung_abun,
                         meta = fung_meta,
                         color_palette = troph_pal,
                         var_to_filt_by = "trophic")


## save plots
ggarrange(fung_hubs_empo[[1]],
          fung_hubs_empo[[2]],
          fung_hubs_empo[[3]],
          fung_hubs_empo[[4]],
          fung_hubs_empo[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/fung_hubs_empo_pies.png", width = 10, height = 3)

ggarrange(fung_hubs_troph[[1]],
          fung_hubs_troph[[2]],
          fung_hubs_troph[[3]],
          fung_hubs_troph[[4]],
          fung_hubs_troph[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/fung_hubs_troph_pies.png", width = 10, height = 3)


ggarrange(fung_hubs_hab[[1]],
          fung_hubs_hab[[2]],
          fung_hubs_hab[[3]],
          fung_hubs_hab[[4]],
          fung_hubs_hab[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/fung_hubs_hab_pies.png", width = 10, height = 3)


```

### Bacteria 
```{r}

bact_hub_names <- bact_hub_data$OTU[1:5]

# how many samples
bact_how_many_samps <- list()
for (a_hub in bact_hub_names) {
  filt_b_abun <- bact_abun[rownames(bact_abun)==a_hub,]
  filt_b_abun <- filt_b_abun[,colSums(filt_b_abun)>0]
  
  bact_how_many_samps[[a_hub]] <- ncol(filt_b_abun)
}

bs_df <- as.data.frame(unlist(bact_how_many_samps))
names(bs_df) <- "how_many_samps"

b_hub_tax <- bact_seed_tax[bact_seed_tax$denovo_OTU %in% bact_hub_names,]
b_hub_tax <- b_hub_tax[,3:9]

bs_df <- cbind(bs_df, b_hub_tax)

saveRDS(bs_df, "../intermediates/global/bact_hubs_how_many_samps.rds")


bact_hubs_empo <- lapply(bact_hub_names,
                         make_pie,
                         abun = bact_abun,
                         meta = bact_meta,
                         color_palette = empo_pal,
                         var_to_filt_by = "empo_3")

bact_hubs_hab <- lapply(bact_hub_names,
                         make_pie,
                         abun = bact_abun,
                         meta = bact_meta,
                         color_palette = hab_pal,
                         var_to_filt_by = "habitat")

bact_hubs_troph <- lapply(bact_hub_names,
                         make_pie,
                         abun = bact_abun,
                         meta = bact_meta,
                         color_palette = troph_pal,
                         var_to_filt_by = "trophic")


## save plots
ggarrange(bact_hubs_empo[[1]],
          bact_hubs_empo[[2]],
          bact_hubs_empo[[3]],
          bact_hubs_empo[[4]],
          bact_hubs_empo[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/bact_hubs_empo_pies.png", width = 10, height = 3)

ggarrange(bact_hubs_troph[[1]],
          bact_hubs_troph[[2]],
          bact_hubs_troph[[3]],
          bact_hubs_troph[[4]],
          bact_hubs_troph[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/bact_hubs_troph_pies.png", width = 10, height = 3)


ggarrange(bact_hubs_hab[[1]],
          bact_hubs_hab[[2]],
          bact_hubs_hab[[3]],
          bact_hubs_hab[[4]],
          bact_hubs_hab[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/bact_hubs_hab_pies.png", width = 10, height = 3)


```

### Cross-domain 
```{r}

cross_hub_names <- cross_hub_data$OTU[1:5]

# how many samples
cross_how_many_samps <- list()
# using bact abun here (not cross) because the main hubs are only bacteria
for (a_hub in cross_hub_names) {
  filt_f_abun <- bact_abun[rownames(bact_abun)==a_hub,]
  filt_f_abun <- filt_f_abun[,colSums(filt_f_abun)>0]
  
  cross_how_many_samps[[a_hub]] <- ncol(filt_f_abun)
}

cs_df <- as.data.frame(unlist(cross_how_many_samps))
names(cs_df) <- "how_many_samps"

c_hub_tax <- bact_seed_tax[bact_seed_tax$denovo_OTU %in% cross_hub_names,]
c_hub_tax <- c_hub_tax[,3:9]

cs_df <- cbind(cs_df, b_hub_tax)

saveRDS(cs_df, "../intermediates/global/cross_hubs_how_many_samps.rds")


cross_hubs_empo <- lapply(cross_hub_names,
                         make_pie,
                         abun = bact_abun,
                         meta = bact_meta,
                         color_palette = empo_pal,
                         var_to_filt_by = "empo_3")

cross_hubs_hab <- lapply(cross_hub_names,
                         make_pie,
                         abun = bact_abun,
                         meta = bact_meta,
                         color_palette = hab_pal,
                         var_to_filt_by = "habitat")

cross_hubs_troph <- lapply(cross_hub_names,
                         make_pie,
                         abun = bact_abun,
                         meta = bact_meta,
                         color_palette = troph_pal,
                         var_to_filt_by = "trophic")


## save plots
ggarrange(cross_hubs_empo[[1]],
          cross_hubs_empo[[2]],
          cross_hubs_empo[[3]],
          cross_hubs_empo[[4]],
          cross_hubs_empo[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/cross_hubs_empo_pies.png", width = 10, height = 3)

ggarrange(cross_hubs_troph[[1]],
          cross_hubs_troph[[2]],
          cross_hubs_troph[[3]],
          cross_hubs_troph[[4]],
          cross_hubs_troph[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/cross_hubs_troph_pies.png", width = 10, height = 3)


ggarrange(cross_hubs_hab[[1]],
          cross_hubs_hab[[2]],
          cross_hubs_hab[[3]],
          cross_hubs_hab[[4]],
          cross_hubs_hab[[5]],
          nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
ggsave("../figures/global/cross_hubs_hab_pies.png", width = 10, height = 3)


```


## Make cross-domain combined abundance table

```{r}
bact_df <- data.frame(seq_id <- bact_meta$sequencing_id,
                      x_seq_id <- bact_meta$x_seq_id,
                      sample <- bact_meta$sample_id)
names(bact_df) <- c("seq_id", "x_seq_id", "sample")

fung_df <- data.frame(seq_id <- fung_meta$sequencing_id,
                      x_seq_id <- fung_meta$x_seq_id,
                      sample <- fung_meta$sample_id)
names(fung_df) <- c("seq_id", "x_seq_id", "sample")


f_abun_test <- fung_abun
names(f_abun_test) <- as.character(fung_df$sample[match(names(f_abun_test), fung_df$x_seq_id)])
f_abun_test <- f_abun_test[, order(names(f_abun_test))]

b_abun_test <- bact_abun
names(b_abun_test) <- as.character(bact_df$sample[match(names(b_abun_test), bact_df$x_seq_id)])
b_abun_test <- b_abun_test[, order(names(b_abun_test))]

all(names(f_abun_test)==names(b_abun_test))


cross_abun <- rbind(f_abun_test, b_abun_test)

saveRDS(cross_abun, "../intermediates/global/prev20_cross_domain_abundance_table.rds")


```


## Keystone

```{r}
# read in data
fung_keystone_data <- readRDS("../intermediates/global/fung_keystone_data.rds")
bact_keystone_data <- readRDS("../intermediates/global/bact_keystone_data.rds")
cross_keystone_data <- readRDS("../intermediates/global/cross_keystone_data.rds")
```


### Fungi
```{r}
fung_keystone_data <- dplyr::arrange(fung_keystone_data, desc(degree), desc(btwn_cen), prevalence)

fung_key_candidates <- fung_keystone_data$OTU[1:3]


# remove keystone node
fung_no_keystone <- delete_vertices(fung_net, fung_key_candidates[1])

# Calculate node removal robustness
fung_nokey_node_robustness <- robustness(fung_no_keystone, type = "vertex", "degree")
fung_nokey_node_robustness$domain <- "fungi, keystone removed"

fung_node_robustness <- robustness(fung_net, type = "vertex", "degree")
fung_node_robustness$domain <- "fungi"


all_fung_robustness <- do.call("rbind", list(fung_node_robustness, fung_nokey_node_robustness))

a <- ggplot(all_fung_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Degree-based attack")

# based on deleting vertex, robustness of the overall network doesn't change 


# Calculate node removal robustness
fung_nokey_bc_robustness <- robustness(fung_no_keystone, type = "vertex", "btwn.cent")
fung_nokey_bc_robustness$domain <- "fungi, keystone removed"

fung_bc_robustness <- robustness(fung_net, type = "vertex", "btwn.cent")
fung_bc_robustness$domain <- "fungi"


all_fung_bc_robustness <- do.call("rbind", list(fung_bc_robustness, fung_nokey_bc_robustness))

b <- ggplot(all_fung_bc_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Betweenness-based attack")

# this one is a little more robust with the keystone removed??


library(ggpubr)

ggarrange(a, b, nrow = 1, common.legend = TRUE, legend = "right")
ggsave("../figures/global/fung_robustness_no_keystone.png", width=15, height=6)


```

### Bacteria
```{r}
bact_keystone_data <- dplyr::arrange(bact_keystone_data, desc(degree), desc(btwn_cen), prevalence)

bact_key_candidates <- bact_keystone_data$OTU[1:3]


# remove keystone node
bact_no_keystone <- delete_vertices(bact_net, bact_key_candidates[1])

# Calculate node removal robustness
bact_nokey_node_robustness <- robustness(bact_no_keystone, type = "vertex", "degree")
bact_nokey_node_robustness$domain <- "Bacteria, keystone removed"

bact_node_robustness <- robustness(bact_net, type = "vertex", "degree")
bact_node_robustness$domain <- "Bacteria"


all_bact_node_robustness <- do.call("rbind", list(bact_node_robustness, bact_nokey_node_robustness))

bact_node_rob_plot <- ggplot(all_bact_node_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Degree-based attack")

# based on deleting vertex, robustness of the overall network doesn't change 


# Calculate node removal robustness
bact_nokey_bc_robustness <- robustness(bact_no_keystone, type = "vertex", "btwn.cent")
bact_nokey_bc_robustness$domain <- "Bacteria, keystone removed"

bact_bc_robustness <- robustness(bact_net, type = "vertex", "btwn.cent")
bact_bc_robustness$domain <- "Bacteria"


all_bact_bc_robustness <- do.call("rbind", list(bact_bc_robustness, bact_nokey_bc_robustness))

bact_bc_rob_plot <- ggplot(all_bact_bc_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Betweenness-based attack")


ggarrange(bact_node_rob_plot, bact_bc_rob_plot, nrow = 1, common.legend = TRUE, legend = "right")
ggsave("../figures/global/bact_robustness_no_keystone.png", width=15, height=6)

```

### Cross-domain
```{r}
cross_keystone_data <- dplyr::arrange(cross_keystone_data, desc(degree), desc(btwn_cen), prevalence)

cross_key_candidates <- cross_keystone_data$OTU[1:3]


# remove keystone node
cross_no_keystone <- delete_vertices(cross_net, cross_key_candidates[1])

# Calculate node removal robustness
cross_nokey_node_robustness <- robustness(cross_no_keystone, type = "vertex", "degree")
cross_nokey_node_robustness$domain <- "Cross-domain, keystone removed"

cross_node_robustness <- robustness(cross_net, type = "vertex", "degree")
cross_node_robustness$domain <- "Cross-domain"


all_cross_node_robustness <- do.call("rbind", list(cross_node_robustness, cross_nokey_node_robustness))

cross_node_rob_plot <- ggplot(all_cross_node_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Degree-based attack")

# based on deleting vertex, robustness of the overall network doesn't change 


# Calculate node removal robustness
cross_nokey_bc_robustness <- robustness(cross_no_keystone, type = "vertex", "btwn.cent")
cross_nokey_bc_robustness$domain <- "Cross-domain, keystone removed"

cross_bc_robustness <- robustness(cross_net, type = "vertex", "btwn.cent")
cross_bc_robustness$domain <- "Cross-domain"


all_cross_bc_robustness <- do.call("rbind", list(cross_bc_robustness, cross_nokey_bc_robustness))

cross_bc_rob_plot <- ggplot(all_cross_bc_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Betweenness-based attack")


ggarrange(cross_node_rob_plot, cross_bc_rob_plot, nrow = 1, common.legend = TRUE, legend = "right")
ggsave("../figures/global/cross_robustness_no_keystone.png", width=15, height=6)


```






this was a test with a newly generated spiec easi network with the keystone removed. brainGraph::robustness() results were identical to using igraph::delete_vertices() for fungi

```{r}
## test robustness against new spiec easi network with keystone removed (fungi)
# read in data = 20% prevalence global networks
fung_net <- readRDS("../intermediates/global/fung20_igraph.rds")

se_fung_nokey <- readRDS("../networks/prev20/outputs/fung_no_keystone_with_dummy.rds")

fung_abun <- readRDS("../intermediates/global/fully_filtered_p20_fungal_otu_table_matched_up.rds")
fung_abun <- fung_abun[rownames(fung_abun)!="fung_otu17170",]

se_nokey_igraph <- adj2igraph(getRefit(se_fung_nokey), vertex.attr=list(name=rownames(fung_abun)))

## REMOVE DUMMY NODE
fung_nokey_no_dummy <- delete_vertices(se_nokey_igraph, "dummy")

# Calculate node removal robustness
se_fung_nokey_bc_robustness <- robustness(fung_nokey_no_dummy, type = "vertex", "btwn.cent")
se_fung_nokey_bc_robustness$domain <- "fungi, keystone removed in spiec-easi"

orig_fung_bc_robustness <- robustness(fung_net, type = "vertex", "btwn.cent")
orig_fung_bc_robustness$domain <- "fungi"


new_all_fung_robustness <- do.call("rbind", list(orig_fung_bc_robustness, se_fung_nokey_bc_robustness))

c <- ggplot(new_all_fung_robustness, aes(x=removed.pct, y=comp.pct, group=domain, color=domain)) +
  geom_line() +
  labs(x="Percentage of nodes removed", y="Size of largest connected component",
       title="Betweenness-based attack")

```










