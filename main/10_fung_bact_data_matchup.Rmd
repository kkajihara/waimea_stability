---
title: "10_fung_bact_data_matchup"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
```

Goal:
-Match up samples between 16S and ITS datasets
-Subset each by site and then empo3 category

Later, run a test network with the subsetted data

```{r}
# read in data - these are 50% prevalence OTUs
fung_otu_table <- readRDS("../networks/input_data/fully_filtered_fung_otu_table.rds") # 329 OTUs, 1451 samples

bact_otu_table <- readRDS("../networks/input_data/bact_prev50_otu_abun.rds") # 3736 OTUs, 1617 samples


full_met <- read.csv("../metadata/all_waimea_hiseq_sample_metadata.csv") # 3468 samples
full_met <- full_met[full_met$habitat %in% c("Marine","Terrestrial","Riverine"),] # 3206 samples


fung_metadata <- full_met[which(full_met$sequencing_id %in% names(fung_otu_table)),] # 1451 samples

bact_metadata <- full_met[which(full_met$sequencing_id %in% names(bact_otu_table)),] # 1498 samples?



fung_meta_raw <- full_met[grep("ITS", full_met$locus, ignore.case = T),] # 1586 samples
bact_meta_raw <- full_met[grep("16S", full_met$locus, ignore.case = T),] # 1620 samples

```

```{r}

fung_meta_match <- fung_metadata[fung_metadata$sample_id %in% bact_metadata$sample_id,]

bact_meta_match <- bact_metadata[bact_metadata$sample_id %in% fung_metadata$sample_id,]

matched_ids <- fung_meta_match$sample_id # 1341 samples


fung_nonmatch_id <- fung_metadata[!(fung_metadata$sample_id %in% matched_ids),]

bact_nonmatch_id <- bact_metadata[!(bact_metadata$sample_id %in% matched_ids),]

f_nonmatch_ids <- fung_nonmatch_id$sample_id # 110 samples
b_nonmatch_ids <- bact_nonmatch_id$sample_id # 157 samples



test <- full_met[full_met$sample_id %in% bact_nonmatch_id$sample_id,]

write.csv(test, "../intermediates/waimea_samples_with_no_complement_between_fung_bact.csv")


a <- fung_metadata[which(fung_metadata$sample_id %in% f_nonmatch_ids),]
b <- bact_metadata[which(bact_metadata$sample_id %in% b_nonmatch_ids),]

library(plyr)

c <- rbind.fill(a, b)

remove_these <- c("is.neg", "photo.notes", "photo")

c <- c[,!(names(c) %in% remove_these)]



c <- fung_metadata[which(fung_metadata$sample_id %in% f_nonmatch_ids),]$sequencing_id
d <- bact_metadata[which(bact_metadata$sample_id %in% b_nonmatch_ids),]$sequencing_id

e <- fung_otu_table[,names(fung_otu_table) %in% c]
e <- e[rowSums(e)>0,]
ee <- apply(e, 1, function(x) sum(x!=0))

f <- bact_otu_table[,names(bact_otu_table) %in% d]
f <- f[rowSums(f)>0,]
ff <- apply(f, 1, function(x) sum(x!=0))



```

```{r}
# subset otu tables by samples matched in 16S and ITS
fung_otu_match <- fung_otu_table[,colnames(fung_otu_table) %in% fung_meta_match$sequencing_id] # 1341 samples remain
fung_otu_match <- fung_otu_match[rowSums(fung_otu_match)>0,] # 329 otus remain (none removed)

bact_otu_match <- bact_otu_table[,colnames(bact_otu_table) %in% bact_meta_match$sequencing_id] # 1341 samples remain
bact_otu_match <- bact_otu_match[rowSums(bact_otu_match)>0,] # 3736 otus remain (none removed)


saveRDS(fung_otu_match, "../intermediates/fungal_otu_table_matched_up.rds")
saveRDS(fung_meta_match, "../intermediates/fungal_otu_metadata_matched_up.rds")
saveRDS(bact_otu_match, "../intermediates/bact_otu_table_matched_up.rds")
saveRDS(bact_meta_match, "../intermediates/bact_otu_metadata_matched_up.rds")
```














